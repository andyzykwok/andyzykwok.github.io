<!DOCTYPE html>
<html>
<link rel="stylesheet" type="text/css" href="https://meyerweb.com/eric/tools/css/reset/reset.css">
<head>
    <title>Mahjong Score Calculator</title>
    <style>
        #viewport {
            width: 100vw;
            height: 100vh;
        }

        #content {
            width: 1280px;
            height: 100vh;
            margin-left: auto;
            margin-right: auto;
            display: flex;
        }

        h1 {
            font-size: 60px;
            margin-bottom: 16px;
        }

        #leftContent {
            width: 50%;
            height: 100vh;
            margin-left: auto;
            margin-right: auto;
        }

        #rightContent {
            width: 50%;
            height: 100vh;
            margin-left: auto;
            margin-right: auto;
        }

        .editNameInput {
            width: 64px;
            display: none;
        }

        .playerScore {
            margin-right: 24px;
        }

        #scoreboard {
            display: flex;
            margin-bottom: 16px;
        }

        .score {
            font-size: 48px;
            font-weight: bold;
        }

        .formSection {
            margin-bottom: 8px;
        }

        td {
          padding: 8px;
        }
    </style>
</head>

<body>
    <div id="viewport">
        <div id="content">
            <div id="leftContent">
                <div>
                    <h1>Mahjong Score Calculator</h1>
                </div>
                <div id="scoreboard">
                    <div id="editName" class="playerScore" onclick="toggleEditNames()">(edit)</div>
                    <div class="playerScore">
                        <input type="text" id="editPlayer0" class="editNameInput" value="Player 0" />
                        <div id="player0" class="playerName">Player 0</div>
                        <div id="player0Score" class="score">0</div>
                    </div>
                    <div class="playerScore">
                        <input type="text" id="editPlayer1" class="editNameInput" value="Player 1" />
                        <div id="player1" class="playerName">Player 1</div>
                        <div id="player1Score" class="score">0</div>
                    </div>
                    <div class="playerScore">
                        <input type="text" id="editPlayer2" class="editNameInput" value="Player 2" />
                        <div id="player2" class="playerName">Player 2</div>
                        <div id="player2Score" class="score">0</div>
                    </div>
                    <div class="playerScore">
                        <input type="text" id="editPlayer3" class="editNameInput" value="Player 3" />
                        <div id="player3" class="playerName">Player 3</div>
                        <div id="player3Score" class="score">0</div>
                    </div>
                </div>
                <div id="gameInput">
                    <div id="winType" class="formSection">
                        <label>Win Type:</label><br>
                        <input type="radio" name="winType" id="regularWin" onclick="onWinTypeClick()"
                            checked>&nbsp;<label for="regularWin">Regular</label>&nbsp;&nbsp;&nbsp;
                        <input type="radio" name="winType" id="nineTileWin" onclick="onWinTypeClick()"
                            >&nbsp;<label for="nineTileWin">9 Tiles Showing</label>&nbsp;&nbsp;&nbsp;
                        <input type="radio" name="winType" id="twelveTileWin" onclick="onWinTypeClick()"
                            >&nbsp;<label for="twelveTileWin">12 Tiles Showing</label>
                    </div>
                    <div class="formSection">
                        <label for="winner">Winner: </label>
                        <select id="winner"></select>
                        <label for="loser" style="margin-left: 8px;">Loser: </label>
                        <select id="loser" onclick="onWinTypeClick()">
                            <option value="-1" id="loserSelfDraw">Self Draw</option>
                        </select>
                        <label id="twelveTileLoserLabel" for="twelveTileLoser"
                            style="margin-left: 8px; display: none;">Twelve Tile Loser:</label>
                        <select id="twelveTileLoser" style="display: none;">
                        </select>
                    </div>
                    <div class="formSection">
                        <label for="faan">Faan: </label>
                        <input type="number" id="faan" min="2" max="10" value="2">
                    </div>
                    <div class="formSection">
                        <input type="button" value="Add Round" onclick="addRound()">
                    </div>
                </div>
            </div>
            <div id="rightContent">
                <table>
                    <thead>
                        <tr id="tableHeaderRow"></tr>
                    </thead>
                    <tbody id="tableContent"></tbody>
                </table>
            </div>
        </div>
</body>
<script>
    function gid(id) {
        return document.getElementById(id);
    }

    function getNames() {
        return Array.from(document.querySelectorAll('.playerName')).map(e => e.innerHTML);
    }

    function faanToPoints(faan) {
        switch (faan) {
            case 2:
            case 3:
            case 4:
                return Math.pow(2, faan + 1);
            case 5:
                return 48;
            case 6:
                return 64
            case 7:
                return 96;
            case 8:
                return 128;
            case 9:
                return 192;
            case 10:
                return 256;
        }
    }

    function toggleEditNames() {
        const editName = gid('editName');
        if (editName.innerHTML === '(edit)') {
            document.querySelectorAll('.playerName').forEach(e => {
                e.style.display = 'none';
            });
            document.querySelectorAll('.editNameInput').forEach(e => {
                e.style.display = 'block';
            });

            gid('editPlayer0').select();
            editName.innerHTML = '(done)';
        } else {
            const inputs = document.querySelectorAll('.editNameInput');
            inputs.forEach(e => {
                e.style.display = 'none';
            });
            document.querySelectorAll('.playerName').forEach((e, i) => {
                e.style.display = 'block';
                e.innerHTML = inputs[i].value;
            });

            editName.innerHTML = '(edit)';
            populateNames();
            update();
        }
    }

    function resetWinTypeSelection() {
        gid('twelveTileLoserLabel').style.display = 'none';
        gid('twelveTileLoser').style.display = 'none';

        gid('loserSelfDraw').removeAttribute('disabled');
        document.querySelectorAll('.loserPlayer').forEach(e => e.removeAttribute('disabled'));
    }

    function onWinTypeClick() {
        const loser = Number(gid("loser").value);

        gid('twelveTileLoserLabel').style.display = 'none';
        gid('twelveTileLoser').style.display = 'none';

        gid('loserSelfDraw').removeAttribute('disabled');
        document.querySelectorAll('.loserPlayer').forEach(e => e.removeAttribute('disabled'));

        if (gid('twelveTileWin').checked) {
            gid('loser').value = '-1';
            gid('twelveTileLoserLabel').style.display = 'inline';
            gid('twelveTileLoser').style.display = 'inline';
            document.querySelectorAll('.loserPlayer').forEach(e => e.setAttribute('disabled', 'disabled'));
        }

        if (gid('nineTileWin').checked) {
            gid('loserSelfDraw').setAttribute('disabled', 'disabled');
            if (loser === -1) {
                gid('loser').value = 0;
            }
        }
    }

    function populateNames() {
        gid('winner').innerHTML = getNames().map((name, i) => '<option value="' + i + '">' + name + '</option>').join('');
        gid('loser').innerHTML = '<option value="-1" id="loserSelfDraw">Self Draw</option>' + getNames().map(
            (name, i) => '<option class="loserPlayer" value="' + i + '">' + name + '</option>'
        ).join('');
        gid('twelveTileLoser').innerHTML = getNames().map((name, i) => '<option value="' + i + '">' + name + '</option>').join('');
        gid('tableHeaderRow').innerHTML = getNames().map(name => '<td>' + name + '</td>').join('') + '<td>Winner</td><td>Loser</td><td>Faan</td><td>Win Type</td>'
    }

    function deleteRound(round) {
        if (confirm('Are you sure you want to delete this round?')) {
            delete rounds[round];
        }
        update();
    }

    function addRound() {
        const winner = Number(gid('winner').value);
        const loser = Number(gid('loser').value);
        const faan = Number(gid('faan').value);

        const nineTileWin = gid('nineTileWin').checked;
        const twelveTileWin = gid('twelveTileWin').checked;
        const twelveTileLoser = Number(gid('twelveTileLoser').value);

        if (winner == loser || (twelveTileWin && winner == twelveTileLoser)) {
            alert('Winner and loser can not be the same person.');
            return;
        }

        rounds.push({
            winner,
            loser,
            winType: twelveTileWin ? 'twelveTileWin' : nineTileWin ? 'nineTileWin' : 'regularWin',
            faan,
            twelveTileLoser: twelveTileWin ? twelveTileLoser : undefined,
        });

        update();
    }

    function update() {

        const names = getNames();
        const scores = [0, 0, 0, 0];

        let tableContent = '';

        rounds.forEach((round, idx) => {
            const basePoints = faanToPoints(round.faan);
            scores.forEach((score, i) => {
                if (round.winner === i) {
                    const winnerPoints = basePoints * (round.loser == -1 ? 3 : 2);
                    scores[i] = scores[i] + winnerPoints;
                } else {
                    if (round.winType === 'twelveTileWin') {
                        if (round.twelveTileLoser === i) {
                            scores[i] = scores[i] - (basePoints * 3);
                        }
                    } else if (round.winType === 'nineTileWin') {
                        if (round.loser === i) {
                            scores[i] = scores[i] - (basePoints * 2);
                        }
                    } else {
                        if (round.loser === -1 || round.loser === i) {
                            scores[i] = scores[i] - basePoints;
                        } else {
                            scores[i] = scores[i] - (basePoints / 2);
                        }
                    }
                }
            });

            const winTypeText = round.winType === 'twelveTileWin'
                ? '12 Tiles Showing'
                : round.winType === 'nineTileWin' ? '9 Tiles Showing' : 'Regular';

            tableContent = tableContent + '<tr><td>' + scores[0] + '</td><td>' + scores[1] + '</td><td>' + scores[2] + '</td><td>' + scores[3] + '</td><td>' + names[round.winner] + '</td><td>' + (round.loser === -1 ? 'Self Draw' : names[round.loser]) + '</td><td>' + round.faan + '</td><td>' + winTypeText + "</td><td><button onclick=\"deleteRound(" + idx + ")\">delete</button></td></tr>";
        });

        scores.forEach((score, i) => {
            gid('player' + i + 'Score').innerHTML = score;
        });
        gid('tableContent').innerHTML = tableContent;
    }

    rounds = [];
    populateNames();
    update();

    window.onbeforeunload = function () {
        return true;
    }
</script>
</html>
